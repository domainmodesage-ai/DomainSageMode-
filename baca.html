<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, user-scalable=yes">
  <title>Baca Komik - Domain Sage Mode</title>
  <!-- Favicon -->
<link rel="icon" href="assets/favicon.png" type="image/png">
<link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="assets/style.css" />
  <link rel="stylesheet" href="assets/baca.css">
  <script src="assets/seo.js"></script>
  <style>
    .image-container {
      position: relative;
      text-align: center;
      margin: 0;
    }

    .lazy-loading {
      background: #000;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      position: relative;
    }

    .progress-bar {
      width: 80%;
      height: 4px;
      background: #333;
      border-radius: 2px;
      overflow: hidden;
      margin: 4px 0 0;
      display: none;
    }

    .progress-bar-fill {
      width: 0%;
      height: 100%;
      background: #f44336;
      transition: width 0.2s;
    }

    .reload-btn {
      background: #f44336;
      color: #fff;
      border: none;
      padding: 4px 8px;
      margin: 4px 0 0;
      border-radius: 4px;
      cursor: pointer;
      display: none;
      font-size: 12px;
    }

    .placeholder {
      color: #888;
      font-size: 12px;
      margin-bottom: 4px;
    }

    img {
      width: 100%;
      display: block;
    }

    .chapter-dropdown {
      margin: 10px;
      text-align: center;
    }
  </style>
</head>
<body>
  <header>
    <div class="logo-header">
      <img src="assets/logo.png" alt="Logo" class="logo-bulat" />
      <h1 class="judul-logo">DOMAIN SAGE MODE</h1>
    </div>
  </header>
  
  <nav>
    <a href="index.html">Beranda</a>
    <a href="cari.html">Cari</a>
    <a href="donasi.html">Dukung Kami</a>
    <a href="bookmark-history.html">Bookmark & History</a>
  </nav>

  <main class="reader" id="bacaArea">
    <p>Memuat halaman komik...</p>
  </main>

  <div class="nav-ch" id="navChapter"></div>
  
  <footer>
    <p>&copy; 2025 Domain Sage Mode. Semua hak cipta komik adalah milik aslinya.</p>
  </footer>

  <script>
    const params = new URLSearchParams(window.location.search);
    const komikId = params.get('id');
    const chIndex = parseInt(params.get('ch')) || 0;

    fetch('data/komik.json')
      .then(res => res.json())
      .then(data => {
        const komik = data.find(k => k.id === komikId);
        const bacaArea = document.getElementById('bacaArea');

        if (!komik) {
          bacaArea.innerHTML = "<p>‚ùå Komik tidak ditemukan.</p>";
          return;
        }

        if (!komik.chapter || !komik.chapter[chIndex]) {
          bacaArea.innerHTML = "<p>‚ùå Chapter tidak ditemukan.</p>";
          return;
        }

// SEO otomatis untuk chapter
if (typeof setChapterSEO === "function") {
  setChapterSEO(komik, komik.chapter[chIndex]);
}

        const chapter = komik.chapter[chIndex];
        const folder = chapter.folder;
        const totalHalaman = chapter.total;

        // Ambil history
        let history = JSON.parse(localStorage.getItem("history") || "[]");
        let existing = history.find(h => h.id === komikId);

        let lastPage = 1;
        if (existing && existing.ch === chIndex && existing.lastPage) {
          lastPage = existing.lastPage;
        }

        if (existing) {
          existing.ch = chIndex;
          existing.lastRead = new Date().toISOString();
          existing.lastPage = lastPage;
        } else {
          history.push({
            id: komikId,
            judul: komik.judul,
            cover: komik.cover,
            ch: chIndex,
            lastPage: 1,
            lastRead: new Date().toISOString()
          });
        }
        localStorage.setItem("history", JSON.stringify(history));

        // Dropdown chapter
        let dropdown = `
          <div class="chapter-dropdown">
            <label for="chapterSelect">Pilih Chapter:</label>
            <select id="chapterSelect">
              ${komik.chapter.map((c, i) =>
                `<option value="${i}" ${i === chIndex ? "selected" : ""}>${c.judul}</option>`
              ).join("")}
            </select>
          </div>
        `;

        // Placeholder gambar
        let images = '';
        for (let i = 1; i <= totalHalaman; i++) {
          images += `
            <div class="image-container lazy-loading" id="container-${i}">
              <div class="placeholder" id="placeholder-${i}">Memuat...</div>
              <div class="progress-bar" id="bar-${i}"><div class="progress-bar-fill" id="progress-${i}"></div></div>
              <button class="reload-btn" id="reload-${i}" onclick="retryImage(${i}, '${folder}/${i}')">üîÑ Muat Ulang</button>
              <img data-src="${folder}/${i}" alt="Halaman ${i}" id="img-${i}" style="display:none;" />
            </div>
          `;
        }

        bacaArea.innerHTML = `<h2>${komik.judul} - ${chapter.judul}</h2>${dropdown}${images}`;

        const formats = ["jpg", "jpeg", "png", "webp"];

        const observer = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              const img = entry.target.querySelector('img');
              const index = img.id.split('-')[1];
              loadImageWithProgress(index, img.dataset.src, formats);

              let hist = JSON.parse(localStorage.getItem("history") || "[]");
              let current = hist.find(h => h.id === komikId);
              if (current) {
                current.lastPage = parseInt(index);
                localStorage.setItem("history", JSON.stringify(hist));
              }

              observer.unobserve(entry.target);
            }
          });
        }, { rootMargin: "200px" });

        for (let i = 1; i <= totalHalaman; i++) {
          observer.observe(document.getElementById(`container-${i}`));
        }

        function loadImageWithProgress(i, basePath, formats, index = 0) {
          if (index >= formats.length) {
            imageError(i);
            return;
          }
          const img = document.getElementById(`img-${i}`);
          const placeholder = document.getElementById(`placeholder-${i}`);
          const progressBar = document.getElementById(`bar-${i}`);
          const progressFill = document.getElementById(`progress-${i}`);
          const reloadBtn = document.getElementById(`reload-${i}`);
          const src = `${basePath}.${formats[index]}`;

          reloadBtn.style.display = "none";
          progressBar.style.display = "none";
          placeholder.textContent = `Memuat gambar ${i}...`;

          const xhr = new XMLHttpRequest();
          xhr.open("GET", src, true);
          xhr.responseType = "blob";

          xhr.onprogress = (e) => {
            if (e.lengthComputable) {
              progressBar.style.display = "block";
              progressFill.style.width = `${(e.loaded / e.total) * 100}%`;
            }
          };

          xhr.onload = () => {
            if (xhr.status === 200) {
              img.src = URL.createObjectURL(xhr.response);
              img.onload = () => {
                placeholder.style.display = "none";
                progressBar.style.display = "none";
                img.style.display = "block";
              };
            } else {
              loadImageWithProgress(i, basePath, formats, index + 1);
            }
          };

          xhr.onerror = () => loadImageWithProgress(i, basePath, formats, index + 1);
          xhr.send();
        }

        function imageError(i) {
          const placeholder = document.getElementById(`placeholder-${i}`);
          const reloadBtn = document.getElementById(`reload-${i}`);
          placeholder.textContent = "‚ùå Gagal memuat gambar.";
          reloadBtn.style.display = "block";
        }

        window.retryImage = function (i, path) {
          loadImageWithProgress(i, path, formats);
        };

        const nav = document.getElementById('navChapter');
        nav.innerHTML = `
          <div class="nav-buttons">
            <a href="${chIndex > 0 ? `baca.html?id=${komikId}&ch=${chIndex - 1}` : '#'}" class="${chIndex > 0 ? '' : 'disabled'}">&laquo; Chapter Sebelumnya</a>
            <a href="komik.html?id=${komikId}">Daftar Chapter</a>
            <a href="${chIndex < komik.chapter.length - 1 ? `baca.html?id=${komikId}&ch=${chIndex + 1}` : '#'}" class="${chIndex < komik.chapter.length - 1 ? '' : 'disabled'}">Chapter Berikutnya &raquo;</a>
          </div>
        `;

        document.getElementById('chapterSelect').addEventListener('change', function () {
          window.location.href = `baca.html?id=${komikId}&ch=${this.value}`;
        });

        if (lastPage > 1) {
          setTimeout(() => {
            const target = document.getElementById(`container-${lastPage}`);
            if (target) target.scrollIntoView({ behavior: 'smooth' });
          }, 500);
        }
      });
  </script>
</body>
</html>
