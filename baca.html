<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1, maximum-scale=5, user-scalable=yes">
  <title>Baca Komik - Domain Sage Mode</title>
  <link rel="stylesheet" href="assets/style.css" />
  <link rel="stylesheet" href="assets/baca.css">
</head>
<body>
  <header>
    <div class="logo-header">
      <img src="assets/logo.png" alt="Logo" class="logo-bulat" />
      <h1 class="judul-logo">DOMAIN SAGE MODE</h1>
    </div>
  </header>
  
  <nav>
    <a href="index.html">Beranda</a>
    <a href="cari.html">Cari</a>
    <a href="donasi.html">Dukung Kami</a>
    <a href="bookmark&history.html">Bookmark & History</a>
  </nav>

  <main class="reader" id="bacaArea">
    <p>Memuat halaman komik...</p>
  </main>

  <div class="nav-ch" id="navChapter"></div>
  
<!-- === KOMENTAR CHAPTER === -->
<div class="chapter-comments-section">
  <h3>Komentar untuk Chapter Ini</h3>
  <div class="chapter-comment-form" id="chapterCommentFormContainer" style="display:none;">
    <img id="chapterUserPhoto" src="assets/default-avatar.png" alt="User Photo">
    <textarea id="chapterCommentInput" placeholder="Tulis komentar..."></textarea>
    <button id="sendChapterCommentBtn">Kirim</button>
  </div>
  <div id="chapterCommentsList"></div>
</div>

  <footer>
    <p>&copy; 2025 Domain Sage Mode. Semua hak cipta komik adalah milik aslinya.</p>
  </footer>

  <script>
    const params = new URLSearchParams(window.location.search);
    const komikId = params.get('id');
    const chIndex = parseInt(params.get('ch')) || 0; // âœ… mendukung chapter 0

    fetch('data/komik.json')
      .then(res => res.json())
      .then(data => {
        const komik = data.find(k => k.id === komikId);
        if (!komik || !komik.chapter[chIndex]) return;

        const folder = komik.chapter[chIndex].folder;
        const totalHalaman = komik.chapter[chIndex].total;
        const bacaArea = document.getElementById('bacaArea');

        // Dropdown daftar chapter
        let dropdown = `
          <div class="chapter-dropdown">
            <select id="chapterSelect">
              ${komik.chapter.map((c, i) =>
                `<option value="${i}" ${i === chIndex ? "selected" : ""}>${c.judul}</option>`
              ).join("")}
            </select>
          </div>
        `;

        // Gambar halaman komik
        let images = '';
        for (let i = 1; i <= totalHalaman; i++) {
          const imgPath = `${folder}/${i}.jpg`;
          images += `
            <div class="image-container" id="container-${i}">
              <div class="image-placeholder loading" id="placeholder-${i}"></div>
              <img 
                src="${imgPath}" 
                alt="Halaman ${i}" 
                id="img-${i}" 
                style="display:none;" 
                onload="showImage(${i})" 
                onerror="imageError(${i}, '${imgPath}')"
              />
            </div>
          `;
        }

        // Masukkan ke halaman
        bacaArea.innerHTML = `
          <h2>${komik.judul} - ${komik.chapter[chIndex].judul}</h2>
          ${dropdown}
          ${images}
        `;

        // Navigasi tombol
        const nav = document.getElementById('navChapter');
        nav.innerHTML = `
          <div class="nav-buttons">
            <a href="${chIndex > 0 ? `baca.html?id=${komikId}&ch=${chIndex - 1}` : '#'}" class="${chIndex > 0 ? '' : 'disabled'}">&laquo; Chapter Sebelumnya</a>
            <a href="komik.html?id=${komikId}">Daftar Chapter</a>
            <a href="${chIndex < komik.chapter.length - 1 ? `baca.html?id=${komikId}&ch=${chIndex + 1}` : '#'}" class="${chIndex < komik.chapter.length - 1 ? '' : 'disabled'}">Chapter Berikutnya &raquo;</a>
          </div>
        `;

        // Event dropdown
        document.getElementById('chapterSelect').addEventListener('change', function () {
          window.location.href = `baca.html?id=${komikId}&ch=${this.value}`;
        });

        // Simpan history
        let history = JSON.parse(localStorage.getItem("history") || "[]");
        history = history.filter(item => item.id !== komikId);
        history.unshift({
          id: komikId,
          chapter: chIndex,
          judul: komik.judul,
          cover: komik.cover,
          chapterJudul: komik.chapter[chIndex].judul,
          waktu: Date.now()
        });
        if (history.length > 30) history = history.slice(0, 30);
        localStorage.setItem("history", JSON.stringify(history));
      });

    function showImage(i) {
      const img = document.getElementById('img-' + i);
      const placeholder = document.getElementById('placeholder-' + i);
      placeholder.style.display = 'none';
      img.style.display = 'block';
    }

    function imageError(i, path) {
      const placeholder = document.getElementById('placeholder-' + i);
      const img = document.getElementById('img-' + i);
      placeholder.classList.remove("loading");
      placeholder.classList.add("error");
      placeholder.innerHTML = `<button onclick="retryImage(${i}, '${path}')">ðŸ”„ Muat Ulang</button>`;
      img.style.display = 'none';
    }

    function retryImage(i, path) {
      const placeholder = document.getElementById('placeholder-' + i);
      const img = document.getElementById('img-' + i);

      placeholder.classList.remove("error");
      placeholder.classList.add("loading");
      placeholder.innerHTML = "";
      img.src = path + "?retry=" + new Date().getTime();
    }
    // === FITUR KOMENTAR CHAPTER ===
const currentUser = JSON.parse(localStorage.getItem("currentUser") || "null");
const chapterKey = `${komikId}_chapter_${chIndex}_comments`;

const chapterCommentsList = document.getElementById("chapterCommentsList");
const chapterCommentFormContainer = document.getElementById("chapterCommentFormContainer");
const chapterCommentInput = document.getElementById("chapterCommentInput");
const sendChapterCommentBtn = document.getElementById("sendChapterCommentBtn");

// Jika user login, tampilkan form komentar
if (currentUser) {
  chapterCommentFormContainer.style.display = "flex";
  document.getElementById("chapterUserPhoto").src = currentUser.photo || "assets/default-avatar.png";
}

// Fungsi untuk memuat komentar
function loadChapterComments() {
  const comments = JSON.parse(localStorage.getItem(chapterKey) || "[]");
  chapterCommentsList.innerHTML = "";
  comments.forEach(c => {
    const div = document.createElement("div");
    div.className = "chapter-comment";
    div.innerHTML = `
      <img src="${c.photo}" alt="avatar">
      <div class="chapter-comment-content">
        <strong>${c.username}</strong>
        <p>${c.text}</p>
      </div>
    `;
    chapterCommentsList.appendChild(div);
  });
}

// Kirim komentar baru
if (currentUser) {
  sendChapterCommentBtn.addEventListener("click", () => {
    const text = chapterCommentInput.value.trim();
    if (!text) return;

    let comments = JSON.parse(localStorage.getItem(chapterKey) || "[]");
    comments.push({
      userId: currentUser.id,
      username: currentUser.username,
      photo: currentUser.photo || "assets/default-avatar.png",
      text
    });

    localStorage.setItem(chapterKey, JSON.stringify(comments));
    chapterCommentInput.value = "";
    loadChapterComments();
  });
}

loadChapterComments();
  </script>
</body>
</html>